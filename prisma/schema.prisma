datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Product {
  id           String    @id @default(cuid())
  sku          String?   @unique
  name_en      String?
  name_pl      String?
  name_de      String?
  description_en String?
  description_pl String?
  description_de String?
  supplierName String?
  supplierLink String?
  priceComment String?
  stock        Int?
  price        Int?
  sizeLength   Int?
  sizeWidth    Int?
  weight       Int?
  length       Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  images       ProductImage[]
  catalogs     ProductCatalog[]
}

model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatbotSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  settings  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model ImageFile {
  id          String        @id @default(cuid())
  filename    String
  filepath    String
  mimetype    String
  size        Int
  width       Int?
  height      Int?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  products    ProductImage[] // Relation to the join table
}

enum CurrencyCode {
  USD
  EUR
  PLN
  GBP
  SEK
}

enum CountryCode {
  PL
  DE
  GB
  US
  SE
}

enum AgentRunStatus {
  queued
  running
  waiting_human
  stopped
  failed
  completed
}

enum AgentMemoryScope {
  session
  longterm
}

enum AgentAuditLevel {
  info
  warning
  error
}

model Currency {
  id        String       @id @default(cuid())
  code      CurrencyCode @unique
  name      String
  symbol    String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  priceGroups PriceGroup[]
  countries   CountryCurrency[]
}

model Country {
  id        String   @id @default(cuid())
  code      CountryCode @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  languages LanguageCountry[]
  currencies CountryCurrency[]
}

model Integration {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  connections IntegrationConnection[]
}

model IntegrationConnection {
  id            String      @id @default(cuid())
  integrationId String      @unique
  name          String
  username      String
  password      String
  playwrightStorageState String?
  playwrightStorageStateUpdatedAt DateTime?
  playwrightHeadless Boolean @default(true)
  playwrightSlowMo Int @default(50)
  playwrightTimeout Int @default(15000)
  playwrightNavigationTimeout Int @default(30000)
  playwrightHumanizeMouse Boolean @default(false)
  playwrightMouseJitter Int @default(6)
  playwrightClickDelayMin Int @default(30)
  playwrightClickDelayMax Int @default(120)
  playwrightInputDelayMin Int @default(20)
  playwrightInputDelayMax Int @default(120)
  playwrightActionDelayMin Int @default(200)
  playwrightActionDelayMax Int @default(900)
  playwrightProxyEnabled Boolean @default(false)
  playwrightProxyServer String?
  playwrightProxyUsername String?
  playwrightProxyPassword String?
  playwrightEmulateDevice Boolean @default(false)
  playwrightDeviceName String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
}

model Language {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  nativeName String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  catalogs  CatalogLanguage[]
  countries LanguageCountry[]
}

model PriceGroup {
  id               String      @id @default(cuid())
  groupId          String      @unique
  isDefault        Boolean     @default(false)
  name             String
  description      String?
  currencyId       String
  type             String
  basePriceField   String
  sourceGroupId    String?
  priceMultiplier  Float       @default(1)
  addToPrice       Int         @default(0)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  currency         Currency    @relation(fields: [currencyId], references: [id])
  sourceGroup      PriceGroup? @relation("PriceGroupDependency", fields: [sourceGroupId], references: [id])
  dependentGroups  PriceGroup[] @relation("PriceGroupDependency")
}

model ProductImage {
  productId   String
  imageFileId String
  assignedAt  DateTime @default(now())

  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  imageFile   ImageFile @relation(fields: [imageFileId], references: [id], onDelete: Cascade)

  @@id([productId, imageFileId])
}

model Catalog {
  id          String          @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean         @default(false)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  products    ProductCatalog[]
  languages   CatalogLanguage[]
}

model ProductCatalog {
  productId   String
  catalogId   String
  assignedAt  DateTime @default(now())

  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  catalog     Catalog @relation(fields: [catalogId], references: [id], onDelete: Cascade)

  @@id([productId, catalogId])
}

model ChatbotAgentRun {
  id        String          @id @default(cuid())
  prompt    String
  model     String?
  tools     String[]        @default([])
  searchProvider String?
  agentBrowser String?
  runHeadless Boolean @default(true)
  status    AgentRunStatus  @default(queued)
  logLines  String[]        @default([])
  requiresHumanIntervention Boolean @default(false)
  errorMessage String?
  memoryKey String?
  recordingPath String?
  planState Json?
  activeStepId String?
  checkpointedAt DateTime?
  startedAt DateTime?
  finishedAt DateTime?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  memoryItems AgentMemoryItem[]
  longTermMemory AgentLongTermMemory[]
  auditLogs   AgentAuditLog[]
  browserSnapshots AgentBrowserSnapshot[]
  browserLogs AgentBrowserLog[]
}

model AgentMemoryItem {
  id        String           @id @default(cuid())
  runId     String?
  scope     AgentMemoryScope @default(session)
  content   String
  metadata  Json?
  createdAt DateTime         @default(now())

  run       ChatbotAgentRun? @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model AgentLongTermMemory {
  id        String           @id @default(cuid())
  memoryKey String
  runId     String?
  scope     AgentMemoryScope @default(longterm)
  content   String
  summary   String?
  tags      String[]         @default([])
  metadata  Json?
  importance Int?
  lastAccessedAt DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  run       ChatbotAgentRun? @relation(fields: [runId], references: [id], onDelete: SetNull)

  @@index([memoryKey])
  @@index([runId])
  @@index([updatedAt])
}

model AgentAuditLog {
  id        String          @id @default(cuid())
  runId     String?
  level     AgentAuditLevel @default(info)
  message   String
  metadata  Json?
  createdAt DateTime        @default(now())

  run       ChatbotAgentRun? @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model AgentBrowserSnapshot {
  id              String   @id @default(cuid())
  runId           String
  url             String
  title           String?
  domHtml         String
  domText         String
  screenshotData  String?
  screenshotPath  String?
  stepId          String?
  mouseX          Int?
  mouseY          Int?
  viewportWidth   Int?
  viewportHeight  Int?
  createdAt       DateTime @default(now())

  run             ChatbotAgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model AgentBrowserLog {
  id        String   @id @default(cuid())
  runId     String
  stepId    String?
  level     String   @default("info")
  message   String
  metadata  Json?
  createdAt DateTime @default(now())

  run       ChatbotAgentRun @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model ChatbotSession {
  id        String           @id @default(cuid())
  title     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  messages  ChatbotMessage[]
  jobs      ChatbotJob[]
}

model ChatbotMessage {
  id         String          @id @default(cuid())
  sessionId  String
  role       String
  content    String
  createdAt  DateTime        @default(now())

  session    ChatbotSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

enum ChatbotJobStatus {
  pending
  running
  completed
  failed
  canceled
}

model ChatbotJob {
  id           String            @id @default(cuid())
  sessionId    String
  status       ChatbotJobStatus  @default(pending)
  model        String?
  payload      Json
  resultText   String?
  errorMessage String?
  createdAt    DateTime          @default(now())
  startedAt    DateTime?
  finishedAt   DateTime?

  session      ChatbotSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model CatalogLanguage {
  catalogId  String
  languageId String
  assignedAt DateTime @default(now())

  catalog    Catalog  @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  language   Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  @@id([catalogId, languageId])
}

model LanguageCountry {
  languageId String
  countryId  String
  assignedAt DateTime @default(now())

  language   Language @relation(fields: [languageId], references: [id], onDelete: Cascade)
  country    Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)

  @@id([languageId, countryId])
}

model CountryCurrency {
  countryId  String
  currencyId String
  assignedAt DateTime @default(now())

  country    Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  currency   Currency @relation(fields: [currencyId], references: [id], onDelete: Cascade)

  @@id([countryId, currencyId])
}

model Slug {
  id        String   @id @default(cuid())
  slug      String   @unique
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  pages     PageSlug[]
}

model Page {
  id          String          @id @default(cuid())
  name        String
  slugs       PageSlug[]
  components  PageComponent[]
  blocks      PageBlock[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model PageSlug {
  pageId    String
  slugId    String
  assignedAt DateTime @default(now())

  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  slug      Slug     @relation(fields: [slugId], references: [id], onDelete: Cascade)

  @@id([pageId, slugId])
}

model PageComponent {
  id        String   @id @default(cuid())
  type      String   // e.g., 'hero', 'text', 'image'
  order     Int
  content   Json
  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Block {
  id        String   @id @default(cuid())
  name      String   @unique
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  pages     PageBlock[]
}

model PageBlock {
  pageId    String
  blockId   String
  assignedAt DateTime @default(now())

  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  block     Block    @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@id([pageId, blockId])
}

model Note {
  id          String    @id @default(cuid())
  title       String
  content     String
  color       String?   @default("#ffffff")
  isPinned    Boolean   @default(false)
  isArchived  Boolean   @default(false)
  isFavorite  Boolean   @default(false)
  notebookId  String?
  notebook    Notebook? @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  tags        NoteTag[]
  categories  NoteCategory[]
  relationsFrom NoteRelation[] @relation("NoteRelationsFrom")
  relationsTo   NoteRelation[] @relation("NoteRelationsTo")
  files       NoteFile[]
}

model NoteFile {
  id          String   @id @default(cuid())
  noteId      String
  slotIndex   Int
  filename    String
  filepath    String
  mimetype    String
  size        Int
  width       Int?
  height      Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, slotIndex])
}

model Theme {
  id                        String   @id @default(cuid())
  name                      String
  notebookId                String?
  notebook                  Notebook? @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  textColor                 String   @default("#e5e7eb")
  backgroundColor           String   @default("#111827")
  markdownHeadingColor      String   @default("#ffffff")
  markdownLinkColor         String   @default("#60a5fa")
  markdownCodeBackground    String   @default("#1f2937")
  markdownCodeText          String   @default("#e5e7eb")
  relatedNoteBorderWidth    Int      @default(1)
  relatedNoteBorderColor    String   @default("#374151")
  relatedNoteBackgroundColor String  @default("#1f2937")
  relatedNoteTextColor      String   @default("#e5e7eb")
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  categories                Category[]
  notebooksAsDefault        Notebook[] @relation("DefaultTheme")

  @@unique([notebookId, name])
}

model Tag {
  id        String    @id @default(cuid())
  name      String
  color     String?   @default("#3b82f6")
  notebookId String?
  notebook  Notebook? @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  notes     NoteTag[]

  @@unique([notebookId, name])
}

model Category {
  id          String         @id @default(cuid())
  name        String
  description String?
  color       String?        @default("#10b981")
  parentId    String?
  parent      Category?      @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]     @relation("CategoryHierarchy")
  themeId     String?
  notebookId  String?
  notebook    Notebook?      @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  theme       Theme?         @relation(fields: [themeId], references: [id], onDelete: SetNull)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  notes       NoteCategory[]

  @@unique([notebookId, name])
}

model Notebook {
  id             String    @id @default(cuid())
  name           String    @unique
  color          String?   @default("#3b82f6")
  defaultThemeId String?
  defaultTheme   Theme?    @relation("DefaultTheme", fields: [defaultThemeId], references: [id], onDelete: SetNull)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  notes          Note[]
  tags           Tag[]
  categories     Category[]
  themes         Theme[]
}

model NoteTag {
  noteId     String
  tagId      String
  assignedAt DateTime @default(now())

  note       Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([noteId, tagId])
}

model NoteCategory {
  noteId     String
  categoryId String
  assignedAt DateTime @default(now())

  note       Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([noteId, categoryId])
}

model NoteRelation {
  sourceNoteId String
  targetNoteId String
  assignedAt   DateTime @default(now())

  sourceNote   Note @relation("NoteRelationsFrom", fields: [sourceNoteId], references: [id], onDelete: Cascade)
  targetNote   Note @relation("NoteRelationsTo", fields: [targetNoteId], references: [id], onDelete: Cascade)

  @@id([sourceNoteId, targetNoteId])
}
